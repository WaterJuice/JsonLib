////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib
//
//  A simple unit test framework.
//  This module handles memory tracking. It contains alternatives to malloc, calloc, and free that can be used which
//  will have tracking. The test library automatically will check for leaks if these functions are used.
//  Note: The functions WjTestLib_Calloc, WjTestLib_Malloc and WjTestLib_Free are declared in WjTestLib.h
//
//  This is free and unencumbered software released into the public domain - November 2019 waterjuice.org
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  IMPORTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "WjTestLib.h"
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  TYPES
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  GLOBALS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static uint64_t     gTotalNumAllocations = 0;
static uint64_t     gTotalNumFrees = 0;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  PUBLIC FUNCTIONS - Declarations in WjTestLib.h
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib_Calloc
//
//  Same syntax as calloc function. This will return a buffer that has been initialised to zero. Tracking is provided
//  with this allocation, so the unit test library will be able to detect memory leaks.
//  Register this test function with your library to use as the allocation function in order to have memory leak
//  checking available.
//  You must also register WjTesLib_Free
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void*
    WjTestLib_Calloc
    (
        size_t      NumOfElements,
        size_t      SizeOfElements
    )
{
    void* allocation = calloc( NumOfElements, SizeOfElements );
    if( NULL != allocation )
    {
        gTotalNumAllocations += 1;
    }
    return allocation;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib_Malloc
//
//  Same syntax as malloc function. This will return a buffer that has not been initialised to zero. Tracking is provided
//  with this allocation, so the unit test library will be able to detect memory leaks.
//  Register this test function with your library to use as the allocation function in order to have memory leak
//  checking available.
//  You must also register WjTesLib_Free
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void*
    WjTestLib_Malloc
    (
        size_t      Size
    )
{
    void* allocation = malloc( Size );
    if( NULL != allocation )
    {
        gTotalNumAllocations += 1;
    }
    return allocation;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib_MallocAndZero
//
//  Same syntax as malloc function. This will return a buffer that has been initialised to zero. Tracking is provided
//  with this allocation, so the unit test library will be able to detect memory leaks.
//  Register this test function with your library to use as the allocation function in order to have memory leak
//  checking available.
//  You must also register WjTesLib_Free
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void*
    WjTestLib_MallocAndZero
    (
        size_t      Size
    )
{
    return WjTestLib_Calloc( 1, Size );
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib_Free
//
//  Same syntax as free function. This will free the buffer allocated with WjTestLib_Malloc or WjTestLib_Calloc.
//  Tracking is provided.
//  Register this function with your library to use as the free function in order to have memory leak
//  checking available.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void
    WjTestLib_Free
    (
        void*       Memory
    )
{
    if( NULL != Memory )
    {
        free( Memory );
        gTotalNumFrees += 1;
        if( gTotalNumFrees > gTotalNumAllocations )
        {
            fprintf( stderr, "***** MEMORY ERROR (MORE FREES THAN ALLOCS) *****\n" );
        }
    }
    else
    {
        fprintf( stderr, "***** MEMORY ERROR (WjTestLib_Free) *****\n" );
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  PUBLIC FUNCTIONS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  WjTestLib_Memory_GetStats
//
//  Gets the total number of allocations and frees that have happened so far
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void
    WjTestLib_Memory_GetStats
    (
        uint64_t*           pTotalAllocs,           // OPTIONAL
        uint64_t*           pTotalFrees,            // OPTIONAL
        uint64_t*           pTotalOutstanding       // OPTIONAL
    )
{
    if( NULL != pTotalAllocs)
    {
        *pTotalAllocs = gTotalNumAllocations;
    }
    if( NULL != pTotalFrees)
    {
        *pTotalFrees = gTotalNumFrees;
    }
    if( NULL != pTotalOutstanding)
    {
        *pTotalOutstanding = gTotalNumAllocations - gTotalNumFrees;
    }
}
